{{ define "main" }}
<div class="book-detail">
    <div class="book-cover">
        <img src="{{ .Params.cover.image | safeURL }}" alt="{{ .Params.cover.alt }}">
    </div>
    <div class="book-info">
        <h1>{{ .Title }}</h1>
        <p>{{ .Description }}</p>

        <h2>Where to Buy</h2>
        <div class="buy-buttons">
            {{ range .Params.buy_links }}
            <a class="buy-button" href="{{ .url }}" target="_blank">{{ .button_text | default (printf "Buy on %s" .name) }}</a>
            {{ end }}
        </div>

        <h2>Preview the Book</h2>
        <button class="preview-button" onclick="openPreview()">üìñ Preview First Chapter</button>

        <h2>Reviews</h2>
        <ul class="reviews">
        {{ range .Params.reviews }}
            <li><strong>{{ .name }}:</strong> {{ .text }}</li>
        {{ end }}
        </ul>

        <h2>About This Book</h2>
        <div class="book-content">
            {{ .Content | markdownify }} 
        </div>
    </div>
</div>

<!-- üìñ Book Preview Modal -->
<div id="preview-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePreview()">&times;</span>

        <!-- Left Arrow -->
        <div class="flip-arrow left-arrow" onclick="bookViewer.flipPrev()">&#10094;</div>
        
        <div id="book-viewer"></div> <!-- Flipbook Container -->

        <!-- Right Arrow -->
        <div class="flip-arrow right-arrow" onclick="bookViewer.flipNext()">&#10095;</div>
    </div>
</div>

/* Navigation Arrows */
.flip-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 40px;
    color: rgba(0, 0, 0, 0.6);
    cursor: pointer;
    padding: 10px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    user-select: none;
    transition: 0.2s;
}

.flip-arrow:hover {
    background: rgba(255, 255, 255, 1);
}

/* Position Arrows */
.left-arrow {
    left: 20px;
}

.right-arrow {
    right: 20px;
}


<style>
/* General styles */
.book-detail {
    display: flex;
    flex-wrap: wrap; /* Allows stacking on mobile */
    gap: 40px; /* Adds space between book cover and text */
    align-items: flex-start;
    justify-content: center;
    padding: 40px 20px;
}

/* Book Cover */
.book-cover {
    flex: 0 1 250px; /* Ensures the cover has a fixed size */
    text-align: center;
}
.book-cover img {
    width: 100%;
    max-width: 250px;
    border-radius: 8px;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
}

/* Book Info */
.book-info {
    flex: 1;
    max-width: 600px;
    padding: 20px;
    line-height: 1.6;
}
.book-info h1 {
    font-size: 28px;
    margin-bottom: 10px;
}
.book-info h2 {
    font-size: 22px;
    margin-top: 25px;
    border-bottom: 2px solid #ff9900; /* Adds a subtle section divider */
    padding-bottom: 5px;
}

/* Buy Buttons */
.buy-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 20px;
}
.buy-button {
    display: inline-block;
    text-align: center;
    background: #ff9900;
    color: white;
    padding: 14px 18px;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
    border-radius: 6px;
    transition: background 0.2s, transform 0.1s;
}
.buy-button:hover {
    background: #cc7a00;
    transform: scale(1.05);
}

/* Preview Button */
.preview-button {
    display: inline-block;
    background: #0073e6;
    color: white;
    padding: 12px 18px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
}
.preview-button:hover {
    background: #005bb5;
}

/* Reviews */
.reviews {
    padding-left: 20px;
    font-style: italic;
}
.reviews li {
    margin-bottom: 10px;
}

/* Book Content */
.book-content h3 {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid #ff9900; /* Matches Reviews & About This Book */
}

/* Bullet Points (Key Topics Covered) */
.book-content ul {
    padding-left: 25px;
    margin-top: 10px;
    line-height: 1.6;
}
.book-content li {
    margin-bottom: 8px;
    list-style-type: "‚úîÔ∏è ";
}

/* üìñ Book Preview Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: white;
    padding: 20px;
    width: 80%;
    max-width: 800px;
    text-align: center;
    border-radius: 10px;
    position: relative;
}
.close {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 28px;
    cursor: pointer;
}

/* Flipbook */
#book-viewer {
    width: 500px;
    height: 850px;
    margin: auto;
}

/* Mobile-friendly */
@media (max-width: 768px) {
    .book-detail {
        flex-direction: column;
        align-items: flex-start;
        padding: 20px;
    }
    .book-info {
        max-width: 100%;
        text-align: left;
        padding: 10px;
    }
    .buy-buttons {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
    }
    .buy-button {
        width: 100%;
        text-align: center;
    }
}
</style>

<!-- üìñ JavaScript for Modal and Flipbook -->
<script src="https://cdn.jsdelivr.net/npm/page-flip@latest/dist/js/page-flip.browser.js"></script>
<script>
let bookViewer;  // Define the flipbook instance globally

function openPreview() {
    document.getElementById("preview-modal").style.display = "flex";

    // Check if PageFlip already exists, destroy it before recreating
    if (bookViewer) {
        bookViewer.destroy();
    }

    // Initialize Flipbook
    bookViewer = new St.PageFlip(document.getElementById("book-viewer"), {
        width: 500, 
        height: 850, 
        maxShadowOpacity: 0.5,
        showCover: true,
        mobileScrollSupport: false
    });

    // Load preview images dynamically
    const images = [];
    for (let i = 1; i <= 44; i++) {  // Adjust max number if needed
        images.push(`/book-previews/serverless-on-kubernetes-with-knative/Chapter1-preview${i}.png`);
    }

    // Create an array of pages
    const pages = images.map(imgSrc => {
        const page = document.createElement("div");
        const img = document.createElement("img");
        img.src = imgSrc;
        img.style.width = "100%";
        img.style.height = "100%";
        page.appendChild(img);
        return page;  // Return the created page
    });

    bookViewer.loadFromHTML(pages);  // Pass an array of elements
    bookViewer.render();
}

function closePreview() {
    document.getElementById("preview-modal").style.display = "none";
    if (bookViewer) {
        bookViewer.destroy();  // Cleanup the flipbook instance
        bookViewer = null;
    }
}
</script>



{{ end }}
