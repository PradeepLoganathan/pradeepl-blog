{{ define "main" }}
<article class="book-single">
    <div class="book-single-container">
        <aside class="book-single-cover">
            <div class="book-cover-wrapper">
                <img src="{{ .Params.cover.image | safeURL }}" alt="{{ .Params.cover.alt | default .Title }}" loading="eager">
            </div>

            {{- if .Params.buy_links }}
            <div class="book-buy-section">
                <h3>Get Your Copy</h3>
                <div class="buy-buttons">
                    {{ range .Params.buy_links }}
                    <a class="buy-button" href="{{ .url }}" target="_blank" rel="noopener">
                        {{ .button_text | default (printf "Buy on %s" .name) }}
                    </a>
                    {{ end }}
                </div>
            </div>
            {{- end }}

            <button class="preview-button" onclick="openPreview()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                Preview First Chapter
            </button>
        </aside>

        <div class="book-single-content">
            <header class="book-header">
                <h1>{{ .Title }}</h1>
                {{- if .Description }}
                <p class="book-subtitle">{{ .Description }}</p>
                {{- end }}
            </header>

            {{- if .Params.reviews }}
            <section class="book-reviews">
                <h2>Reviews</h2>
                <div class="reviews-list">
                    {{ range .Params.reviews }}
                    <div class="review-item">
                        <div class="review-header">
                            <strong class="review-author">{{ .name }}</strong>
                            <span class="review-stars">
                                {{ range seq .rating }}‚≠ê{{ end }}
                            </span>
                        </div>
                        <p class="review-text">{{ .text }}</p>
                    </div>
                    {{ end }}
                </div>
            </section>
            {{- end }}

            <section class="book-about">
                <h2>About This Book</h2>
                <div class="book-description">
                    {{ .Content }}
                </div>
            </section>
        </div>
    </div>
</article>

<!-- üìñ Book Preview Modal -->
<div id="preview-modal" class="book-preview-modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closePreview()" aria-label="Close preview">&times;</button>
        <button class="flip-arrow left-arrow" onclick="bookViewer.flipPrev()" aria-label="Previous page">&#10094;</button>
        <div id="book-viewer"></div>
        <button class="flip-arrow right-arrow" onclick="bookViewer.flipNext()" aria-label="Next page">&#10095;</button>
    </div>
</div>

<!-- üìñ JavaScript for Modal and Flipbook -->
<script src="https://cdn.jsdelivr.net/npm/page-flip@latest/dist/js/page-flip.browser.js"></script>
<script>
// Define the flipbook instance globally
let bookViewer = null;  

function openPreview() {
    console.log("Opening preview...");

    const previewModal = document.getElementById("preview-modal");
    let bookViewerContainer = document.getElementById("book-viewer");

    // ‚úÖ Ensure modal and container exist before proceeding
    if (!previewModal) {
        console.error("Error: #preview-modal not found.");
        return;
    }

    // ‚úÖ If book-viewer does not exist, recreate it inside the modal
    if (!bookViewerContainer) {
        console.warn("Warning: #book-viewer was removed. Recreating...");
        bookViewerContainer = document.createElement("div");
        bookViewerContainer.id = "book-viewer";
        previewModal.querySelector(".modal-content").appendChild(bookViewerContainer);
    } else {
        // ‚úÖ Clear old contents without removing the container itself
        bookViewerContainer.innerHTML = "";
    }

    // Show the modal
    previewModal.classList.add("active");

    // Destroy previous instance of PageFlip if it exists
    if (bookViewer) {
        console.log("Destroying previous PageFlip instance...");
        bookViewer.destroy();
        bookViewer = null;
    }

    const viewportWidth = window.innerWidth;
    let bookWidth = Math.min(600, viewportWidth * 0.85); // Scale down if needed
    let bookHeight = bookWidth * 1.414; // Maintain A4 aspect ratio

    // ‚úÖ Center the book inside the modal
    bookViewerContainer.style.width = `${bookWidth}px`;
    bookViewerContainer.style.height = `${bookHeight}px`;
    bookViewerContainer.style.margin = "auto";

    // ‚úÖ Correctly initialize PageFlip with responsive dimensions
    bookViewer = new St.PageFlip(bookViewerContainer, {
        width: bookWidth,
        height: bookHeight,
        maxShadowOpacity: 0.5,
        showCover: true,
        mobileScrollSupport: true
    });


    // Load preview images dynamically
    const images = [];
    for (let i = 1; i <= 39; i++) {  
        images.push(`/book-previews/serverless-on-kubernetes-with-knative/Chapter1-preview${i}.webp`);
    }

    // ‚úÖ Load images properly into the flipbook
    if (bookViewer) {
        console.log("Loading pages into flipbook...");
        bookViewer.loadFromImages(images); // ‚úÖ Correct function to load images
        bookViewer.update(); // ‚úÖ Instead of .render(), use .update()
    } else {
        console.error("Error: bookViewer is not initialized correctly.");
    }
}

function closePreview() {
    console.log("Closing preview...");

    const previewModal = document.getElementById("preview-modal");
    const bookViewerContainer = document.getElementById("book-viewer");

    // ‚úÖ Ensure modal exists before proceeding
    if (!previewModal) {
        console.error("Error: #preview-modal not found.");
        return;
    }

    // Hide the modal
    previewModal.classList.remove("active");

    // ‚úÖ Properly destroy the flipbook instance before closing
    if (bookViewer) {
        console.log("Destroying PageFlip instance...");
        bookViewer.destroy();
        bookViewer = null;
    }

    // ‚úÖ Keep #book-viewer container but clear its content
    if (bookViewerContainer) {
        bookViewerContainer.innerHTML = "";
    }
}
   
</script>



{{ end }}
